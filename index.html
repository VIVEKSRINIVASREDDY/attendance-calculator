<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0c0e18" />
  <title>Attendance Calculator</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
  <!-- Prevent flash of wrong theme / restore zoom -->
  <script>
    (function() {
      var t = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', t);
      var z = parseFloat(localStorage.getItem('pageZoom')) || 1;
      document.documentElement.style.zoom = z;
    })();
  </script>
</head>
<body>

  <!-- Loading Screen -->
  <div id="loader">
    <div class="loader-inner">
      <div class="loader-ring"></div>
      <div class="loader-logo">AC</div>
    </div>
    <p class="loader-text">Attendance Calculator</p>
    <p class="loader-sub">Loading your data...</p>
  </div>

  <header>
    <!-- 3-dot menu -->
    <button class="menu-btn" id="menu-btn" aria-label="Options" title="Options">
      <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
        <circle cx="12" cy="5"  r="1.8"/>
        <circle cx="12" cy="12" r="1.8"/>
        <circle cx="12" cy="19" r="1.8"/>
      </svg>
    </button>

    <div class="menu-dropdown" id="menu-dropdown">
      <!-- Theme row -->
      <div class="menu-row" id="theme-row">
        <span class="menu-row-icon" id="menu-theme-icon"></span>
        <span class="menu-row-label" id="menu-theme-label">Dark Mode</span>
        <div class="toggle-switch theme-sw">
          <div class="toggle-knob"></div>
        </div>
      </div>
      <div class="menu-divider"></div>
      <!-- Size row -->
      <div class="menu-row menu-row-size">
        <span class="menu-row-label">Text Size</span>
        <div class="menu-size-group">
          <button id="size-down" aria-label="Decrease">A−</button>
          <span id="size-val">100%</span>
          <button id="size-up" aria-label="Increase">A+</button>
        </div>
      </div>
    </div>

    <h1>Attendance Calculator</h1>
    <p>College Attendance Tracker</p>
  </header>

  <div class="scroll-content">

    <div class="settings-bar">
      <label for="threshold">Minimum Required Attendance</label>
      <input type="number" id="threshold" min="1" max="100" value="75" inputmode="numeric" />
      <span class="pct-symbol">%</span>
    </div>

    <div class="summary">
      <div class="summary-card">
        <div class="val" id="s-total-pct" style="color:var(--accent)">—</div>
        <div class="lbl">Overall</div>
      </div>
      <div class="summary-card">
        <div class="val" id="s-subjects">0</div>
        <div class="lbl">Subjects</div>
      </div>
      <div class="summary-card">
        <div class="val" id="s-safe" style="color:var(--success)">0</div>
        <div class="lbl">Safe</div>
      </div>
      <div class="summary-card">
        <div class="val" id="s-danger" style="color:var(--danger)">0</div>
        <div class="lbl">At Risk</div>
      </div>
    </div>

    <div class="overall-info" id="overall-detail" style="display:none">
      <span class="overall-info-icon">ℹ️</span>
      <span id="od-status-val"></span>
    </div>

    <div class="section-label">Subjects</div>
    <div id="subjects-container"></div>

    <div class="add-row">
      <button id="add-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="16" height="16"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Add Subject
      </button>
      <button class="btn-catalog" id="catalog-btn">
        <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><circle cx="17.5" cy="17.5" r="3.5"/></svg>
        Browse Catalog
      </button>
    </div>

    <div class="actions">
      <button class="btn btn-secondary" id="clear-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/></svg>
        Clear
      </button>
      <button class="btn btn-primary" id="save-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        Save Data
      </button>
    </div>

  </div>

  <div id="toast"></div>

  <!-- Course Catalog Modal -->
  <div class="modal-overlay" id="catalog-overlay">
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <h2>Course Catalog &mdash; LPU B.Tech CSE</h2>
        <button class="modal-close" id="catalog-close">&#10005;</button>
      </div>
      <div class="catalog-search-wrap">
        <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input type="text" id="catalog-search" placeholder="Search by code or title&hellip;" autocorrect="off" autocapitalize="off" spellcheck="false" />
      </div>
      <div class="catalog-tabs" id="catalog-tabs"></div>
      <div id="catalog-list"></div>
    </div>
  </div>

  <script>
    let subjects  = [];
    let threshold = 75;

    const container      = document.getElementById('subjects-container');
    const thresholdInput = document.getElementById('threshold');

    function loadFromStorage() {
      try {
        const raw = localStorage.getItem('attendanceData');
        if (raw) {
          const data = JSON.parse(raw);
          subjects  = data.subjects  || [];
          threshold = data.threshold || 75;
        }
      } catch (_) {}
      if (subjects.length === 0) addBlankSubject();
      thresholdInput.value = threshold;
      renderAll();
    }

    function autoSave() {
      localStorage.setItem('attendanceData', JSON.stringify({ subjects, threshold }));
    }

    function saveToStorage() {
      autoSave();
      showToast('Data saved');
    }

    function pct(attended, total) {
      return total ? (attended / total) * 100 : 0;
    }

    function addBlankSubject() {
      subjects.push({ id: Date.now(), name: '', total: '', attended: '', customThreshold: '' });
    }

    function getSubject(id) {
      return subjects.find(s => s.id === id);
    }

    function escHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;').replace(/</g, '&lt;')
        .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function getStatusMsg(attended, total, thr) {
      if (!total) return 'Enter values and press Calculate';
      const current  = pct(attended, total);
      const minNeeded = Math.ceil((thr / 100) * total);
      const deficit   = Math.max(0, minNeeded - attended);
      const metaLine  = '<div class="status-meta">Min. required: <strong>' + minNeeded + '</strong> / ' + total + ' classes &nbsp;|&nbsp; You attended: <strong>' + attended + '</strong></div>';

      if (current >= thr) {
        const canSkip = Math.floor((attended * 100 / thr) - total);
        if (canSkip <= 0) return metaLine + '<div class="status-main ok-txt">You are exactly at the limit — do not miss any more classes.</div>';
        return metaLine + '<div class="status-main ok-txt">You can skip up to <span class="highlight ok">' + canSkip + '</span> more class' + (canSkip !== 1 ? 'es' : '') + ' and stay above ' + thr + '%.</div>';
      } else {
        const need = Math.ceil((thr / 100 * total - attended) / (1 - thr / 100));
        if (!isFinite(need) || need < 0) return metaLine + '<div class="status-main bad-txt">Attendance cannot be recovered — threshold is set to 100%.</div>';
        return metaLine + '<div class="status-main bad-txt">Attend next <span class="highlight bad">' + need + '</span> consecutive class' + (need !== 1 ? 'es' : '') + ' to reach ' + thr + '%. &nbsp;<span class="deficit">(' + deficit + ' more needed)</span></div>';
      }
    }

    function renderCard(subj) {
      const attended   = parseFloat(subj.attended) || 0;
      const total      = parseFloat(subj.total)    || 0;
      const p          = pct(attended, total);
      const effThr     = (subj.customThreshold !== '' && subj.customThreshold !== null)
                           ? parseFloat(subj.customThreshold) : threshold;

      let colorClass = '', fillColor = 'var(--text-muted)';
      if (total > 0) {
        if      (p >= 75) { colorClass = 'safe';   fillColor = 'var(--success)'; }
        else if (p >= 60) { colorClass = 'info';   fillColor = 'var(--info)'; }
        else if (p >= 50) { colorClass = 'warn';   fillColor = 'var(--warning)'; }
        else              { colorClass = 'danger'; fillColor = 'var(--danger)'; }
      }

      const statusText = total ? getStatusMsg(attended, total, effThr) : 'Enter values and press Calculate';
      const pctDisplay = total ? p.toFixed(1) + '%' : '—';
      const isIdle     = !total;

      const card = document.createElement('div');
      card.className  = 'subject-card ' + colorClass;
      card.dataset.id = subj.id;

      card.innerHTML =
        '<div class="card-name-row">' +
          '<input class="subject-name" type="text" placeholder="Subject name" value="' + escHtml(subj.name) + '" autocorrect="off" autocapitalize="words" spellcheck="false" />' +
          '<button class="btn-delete" title="Remove">DEL</button>' +
        '</div>' +
        '<div class="card-inputs-row">' +
          '<div class="input-group">' +
            '<label>Attended</label>' +
            '<input type="number" class="inp-attended" min="0" placeholder="0" value="' + subj.attended + '" inputmode="numeric" />' +
          '</div>' +
          '<div class="input-group">' +
            '<label>Delivered</label>' +
            '<input type="number" class="inp-total" min="0" placeholder="0" value="' + subj.total + '" inputmode="numeric" />' +
          '</div>' +
          '<div class="input-group input-group-thr">' +
            '<label>Required %</label>' +
            '<input type="number" class="inp-thr" min="1" max="100" placeholder="' + threshold + '" value="' + (subj.customThreshold !== '' ? subj.customThreshold : '') + '" inputmode="numeric" />' +
          '</div>' +
        '</div>' +
        '<div class="card-bottom">' +
          '<div class="progress-row">' +
            '<div class="progress-track">' +
              '<div class="progress-fill" style="width:' + Math.min(p, 100).toFixed(1) + '%;background:' + fillColor + '"></div>' +
            '</div>' +
            '<span class="pct-label" style="color:' + fillColor + '">' + pctDisplay + '</span>' +
          '</div>' +
          '<div class="status-msg">' + statusText + '</div>' +
        '</div>';

      card.querySelector('.subject-name').addEventListener('input', function(e) {
        getSubject(subj.id).name = e.target.value;
        scheduleSave();
      });

      var attInp = card.querySelector('.inp-attended');
      var totInp = card.querySelector('.inp-total');
      var thrInp = card.querySelector('.inp-thr');

      function syncInputs(andRender) {
        var s  = getSubject(subj.id);
        var tv = parseFloat(totInp.value);
        var av = parseFloat(attInp.value);
        s.total    = isNaN(tv) ? '' : Math.max(0, tv);
        s.attended = isNaN(av) ? '' : Math.max(0, av);
        var thrv   = parseFloat(thrInp.value);
        s.customThreshold = isNaN(thrv) ? '' : Math.min(100, Math.max(1, thrv));
        // Only clamp attended > total on explicit Calculate, not during live typing
        if (andRender && s.total !== '' && s.attended !== '' && parseFloat(s.attended) > parseFloat(s.total)) {
          showToast('⚠️ Attended cannot exceed total classes', 'warn');
          attInp.classList.add('inp-error');
          setTimeout(function() { attInp.classList.remove('inp-error'); }, 2000);
          s.attended = s.total;
          attInp.value = s.total;
        }
        // Auto-calculate as soon as both fields have values
        if (s.total !== '' && s.attended !== '') {
          scheduleRender();
        } else if (andRender) {
          scheduleRender();
        } else {
          scheduleSave();
        }
      }

      // Blur sanitization — clamp pasted/typed values on focus-out
      [attInp, totInp].forEach(function(inp) {
        inp.addEventListener('blur', function() {
          var v = parseFloat(inp.value);
          if (!isNaN(v)) inp.value = Math.max(0, Math.round(v));
        });
      });
      thrInp.addEventListener('blur', function() {
        var v = parseFloat(thrInp.value);
        if (!isNaN(v)) thrInp.value = Math.min(100, Math.max(1, Math.round(v)));
      });

      // Keyboard flow: Enter moves to next input
      var flowInputs = [attInp, totInp, thrInp];
      flowInputs.forEach(function(inp, idx) {
        inp.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            if (idx < flowInputs.length - 1) flowInputs[idx + 1].focus();
          }
        });
        inp.addEventListener('input', function() { syncInputs(false); });
      });

      card.querySelector('.btn-delete').addEventListener('click', function() {
        subjects = subjects.filter(function(x) { return x.id !== subj.id; });
        if (subjects.length === 0) addBlankSubject();
        renderAll();
      });

      return card;
    }

    function renderAll() {
      autoSave();
      container.innerHTML = '';
      subjects.forEach(function(s) { container.appendChild(renderCard(s)); });
      updateSummary();
    }

    function updateSummary() {
      var valid        = subjects.filter(function(s) { return parseFloat(s.total) > 0; });
      var totalClasses = valid.reduce(function(a, s) { return a + parseFloat(s.total); }, 0);
      var totalAtt     = valid.reduce(function(a, s) { return a + (parseFloat(s.attended) || 0); }, 0);
      var overall      = totalClasses ? totalAtt / totalClasses * 100 : null;
      var safe         = valid.filter(function(s) {
        var effThr = (s.customThreshold !== '' && s.customThreshold !== null) ? parseFloat(s.customThreshold) : threshold;
        return pct(parseFloat(s.attended) || 0, parseFloat(s.total)) >= effThr;
      }).length;

      var pctEl = document.getElementById('s-total-pct');
      pctEl.textContent = overall !== null ? overall.toFixed(1) + '%' : '—';
      var overallColor = 'var(--accent)';
      if (overall !== null) {
        if      (overall >= 75) overallColor = 'var(--success)';
        else if (overall >= 60) overallColor = 'var(--info)';
        else if (overall >= 50) overallColor = 'var(--warning)';
        else                    overallColor = 'var(--danger)';
      }
      pctEl.style.color = overallColor;
      document.getElementById('s-subjects').textContent = subjects.filter(function(s) { return s.name.trim() || s.total !== '' || s.attended !== ''; }).length;
      document.getElementById('s-safe').textContent     = safe;
      document.getElementById('s-danger').textContent   = valid.length - safe;

      // Overall detail bar
      var detailEl = document.getElementById('overall-detail');
      if (!valid.length) { detailEl.style.display = 'none'; return; }
      detailEl.style.display = 'flex';

      var totalMinNeeded = valid.reduce(function(a, s) {
        var effThr = (s.customThreshold !== '' && s.customThreshold !== null) ? parseFloat(s.customThreshold) : threshold;
        return a + Math.ceil((effThr / 100) * parseFloat(s.total));
      }, 0);
      var deficit = totalMinNeeded - totalAtt;

      document.getElementById('od-min') && (document.getElementById('od-min').textContent = '');

      var statusVal = document.getElementById('od-status-val');
      var detailEl  = document.getElementById('overall-detail');
      if (deficit <= 0) {
        var canSkipOverall = Math.floor(totalAtt - (threshold / 100) * totalClasses);
        canSkipOverall = Math.max(0, canSkipOverall);
        statusVal.innerHTML = 'You can skip up to <strong>' + canSkipOverall + '</strong> more class' + (canSkipOverall !== 1 ? 'es' : '') + ' across all subjects and still meet the minimum attendance.';
        detailEl.classList.remove('info-danger');
        detailEl.classList.add('info-safe');
      } else {
        statusVal.innerHTML = 'Attend <strong>' + deficit + '</strong> more class' + (deficit !== 1 ? 'es' : '') + ' across all subjects to fulfil your overall minimum attendance requirement.';
        detailEl.classList.remove('info-safe');
        detailEl.classList.add('info-danger');
      }
    }

    var renderTimer = null;
    function scheduleRender() { clearTimeout(renderTimer); renderTimer = setTimeout(renderAll, 80); }

    var saveTimer = null;
    function scheduleSave() { clearTimeout(saveTimer); saveTimer = setTimeout(updateSummary, 80); }

    function showToast(msg, type) {
      var toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.remove('toast-warn');
      if (type === 'warn') toast.classList.add('toast-warn');
      toast.classList.add('show');
      clearTimeout(toast._timer);
      toast._timer = setTimeout(function() { toast.classList.remove('show'); }, 2400);
    }

    document.getElementById('add-btn').addEventListener('click', function() {
      addBlankSubject();
      renderAll();
      setTimeout(function() {
        var last = container.lastElementChild;
        if (last) { last.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
        var inp = last && last.querySelector('.subject-name');
        if (inp) inp.focus();
      }, 60);
    });

    var threshTimer = null;
    thresholdInput.addEventListener('input', function() {
      clearTimeout(threshTimer);
      threshTimer = setTimeout(function() {
        var val = parseFloat(thresholdInput.value);
        threshold = isNaN(val) ? 75 : Math.min(100, Math.max(1, val));
        renderAll();
      }, 200);
    });
    thresholdInput.addEventListener('blur', function() {
      var val = parseFloat(thresholdInput.value);
      if (isNaN(val) || val < 1)  { thresholdInput.value = 1;   threshold = 1; }
      if (val > 100)               { thresholdInput.value = 100; threshold = 100; }
      renderAll();
    });

    document.getElementById('save-btn').addEventListener('click', saveToStorage);

    document.getElementById('clear-btn').addEventListener('click', function() {
      if (confirm('Clear all subjects and reset data?')) {
        subjects = [];
        addBlankSubject();
        renderAll();
        showToast('Cleared');
      }
    });

    loadFromStorage();

    /* ── Course Catalog ─────────────────────────────────────── */
    var CATALOG = {
      'Term 1': [
        {code:'CSE111', title:'Orientation to Computing I'},
        {code:'CSE326', title:'Internet Programming Laboratory'},
        {code:'INT108', title:'Python Programming'},
        {code:'MTH174', title:'Engineering Mathematics'},
        {code:'PES318', title:'Soft Skills I'},
        {code:'ECE249', title:'Basic Electrical and Electronics Engineering'},
        {code:'MEC136', title:'Engineering Graphics and Digital Fabrication'},
        {code:'CHE110', title:'Environmental Studies'},
        {code:'PHY110', title:'Engineering Physics'},
        {code:'ECE279', title:'Basic Electrical and Electronics Engineering Laboratory'}
      ],
      'Term 2': [
        {code:'CSE101', title:'Computer Programming'},
        {code:'CSE121', title:'Orientation to Computing II'},
        {code:'CSE320', title:'Software Engineering'},
        {code:'INT306', title:'Database Management Systems'},
        {code:'MTH401', title:'Discrete Mathematics'},
        {code:'PEL121', title:'Communication Skills I'},
        {code:'PEL125', title:'Upper Intermediate Communication Skills I'},
        {code:'PEL130', title:'Advanced Communication Skills I'}
      ],
      'Term 3': [
        {code:'CSE202', title:'Object Oriented Programming'},
        {code:'CSE205', title:'Data Structures and Algorithms'},
        {code:'CSE211', title:'Computer Organization and Design'},
        {code:'CSE306', title:'Computer Networks'},
        {code:'CSE307', title:'Internetworking Essentials'},
        {code:'GEN231', title:'Community Development Project'},
        {code:'CSE316', title:'Operating Systems'},
        {code:'MTH302', title:'Probability and Statistics'},
        {code:'CSE325', title:'Operating Systems Laboratory'},
        {code:'PEL132', title:'Communication Skills II'},
        {code:'PEL134', title:'Upper Intermediate Communication Skills II'},
        {code:'PEL136', title:'Advanced Communication Skills II'}
      ],
      'Term 4': [
        {code:'CSE310', title:'Programming in Java'},
        {code:'CSE408', title:'Design and Analysis of Algorithms'},
        {code:'INT428', title:'Artificial Intelligence Essentials'},
        {code:'PEA305', title:'Analytical Skills I'},
        {code:'PEA307', title:'Advanced Analytical Skills I'},
        {code:'INT330', title:'Managing Cloud Solutions'},
        {code:'INT242', title:'Cyber Security Essentials'},
        {code:'INT217', title:'Introduction to Data Management'},
        {code:'INT219', title:'Front End Web Developer'},
        {code:'ECE217', title:'Introduction to Internet of Things'},
        {code:'INT254', title:'Foundations of Machine Learning'},
        {code:'CSE374', title:'Advance Software Engineering'},
        {code:'INT362', title:'Cloud Architecture and Implementation I'},
        {code:'INT249', title:'System Administration'},
        {code:'INT375', title:'Data Science Toolbox: Python Programming'},
        {code:'INT220', title:'Server Side Scripting'},
        {code:'ECE341', title:'Programming IoT'},
        {code:'INT354', title:'Machine Learning I'},
        {code:'CSE375', title:'Software Testing'}
      ],
      'Term 5': { subgroups: [
        { label: 'Core Subjects', courses: [
          {code:'CSE322', title:'Formal Languages and Automation Theory'},
          {code:'CSE376', title:'Automated Testing'},
          {code:'CSE377', title:'Advance Testing Technologies'},
          {code:'PEA306', title:'Analytical Skills II'},
          {code:'PEA308', title:'Advanced Analytical Skills II'},
          {code:'CSE329', title:'Prelude to Competitive Coding'},
          {code:'CSE333', title:'Combinatorial Studies I'},
          {code:'CSE330', title:'Competitive Coding Approaches — Techniques'},
          {code:'PEV301', title:'Verbal Ability'},
          {code:'CSE343', title:'Training in Programming'},
          {code:'CSE443', title:'Seminar on Summer Training'}
        ]},
        { label: 'Elective / Minor', courses: [
          {code:'INT363', title:'Cloud Microservices'},
          {code:'INT250', title:'Digital Evidence Analysis'},
          {code:'INT374', title:'Data Analytics with Power BI'},
          {code:'INT252', title:'Web App Development with ReactJS'},
          {code:'ECE128', title:'Introduction to IoT Networking Protocols'},
          {code:'INT344', title:'Natural Language Processing'},
          {code:'INT364', title:'Cloud Architecture and Implementation II'},
          {code:'INT244', title:'Securing Computing Systems'},
          {code:'INT234', title:'Predictive Analytics'},
          {code:'INT222', title:'Advanced Web Development'},
          {code:'ECE237', title:'Architecting Smart IoT Devices'},
          {code:'INT423', title:'Machine Learning II'}
        ]}
      ]},
      'Term 6': { subgroups: [
        { label: 'Core Subjects', courses: [
          {code:'CSE332', title:'Industry Ethics and Legal Issues'},
          {code:'CSE393', title:'Online Academic Course'},
          {code:'CSE378', title:'Web Services API Automation Testing'},
          {code:'CSE334', title:'Combinatorial Studies II'},
          {code:'CSE331', title:'Coding Pearls'},
          {code:'CSE357', title:'Combinatorial Studies'},
          {code:'PES319', title:'Soft Skills II'}
        ]},
        { label: 'Elective / Minor', courses: [
          {code:'INT327', title:'Cloud Infrastructure and Resource Management'},
          {code:'INT245', title:'Penetration Testing'},
          {code:'INT312', title:'Big Data Fundamentals'},
          {code:'INT221', title:'MVC Programming'},
          {code:'ECE129', title:'IoT for Digital Society'},
          {code:'INT345', title:'Computer Vision'}
        ]}
      ]},
      'Term 7': [
        {code:'CSE339', title:'Capstone Project I'},
        {code:'CSE304', title:'Computer Graphics and Visualization'},
        {code:'CSE327', title:'Simulation and Modelling'},
        {code:'CSE406', title:'Advanced Java Programming'},
        {code:'CSE434', title:'Game Development in 3D'},
        {code:'CSE436', title:'Blockchain'},
        {code:'INT402', title:'Modern Web Programming Tools and Techniques'},
        {code:'CSE328', title:'Simulation and Modelling Laboratory'},
        {code:'INT328', title:'Network Virtualization and Cloud Security'},
        {code:'INT251', title:'Malware Analysis and Cyber Defence'},
        {code:'INT315', title:'Cluster Computing'},
        {code:'INT253', title:'Web Development in Python using Django'},
        {code:'ECE140', title:'Workshop on IoT for Digital Society'},
        {code:'INT422', title:'Deep Learning'},
        {code:'CSE379', title:'Mobile Automated Testing'},
        {code:'CSE335', title:'Combinatorial Studies III'},
        {code:'CSE447', title:'Industry Co-Op Project I'}
      ],
      'Term 8': [
        {code:'CSE435', title:'Comprehensive Seminar'},
        {code:'CSE439', title:'Capstone Project II'},
        {code:'CSE403', title:'Network Security and Cryptography'},
        {code:'CSE493', title:'Linux System Administration'},
        {code:'CSE504', title:'Storage Technology Foundation'},
        {code:'INT411', title:'Software Project Management'},
        {code:'CSE507', title:'Storage Technology Foundation Laboratory'},
        {code:'INT416', title:'Software Project Management Laboratory'},
        {code:'CSE441', title:'Industry Internship Project'},
        {code:'CSE448', title:'Industry Co-Op Project II'}
      ]
    };

    var catalogActiveTerm = 'All';
    var catalogQuery      = '';

    function openCatalog() {
      document.getElementById('catalog-overlay').classList.add('open');
      document.getElementById('catalog-search').value = '';
      catalogQuery = '';
      catalogActiveTerm = 'All';
      buildCatalogTabs();
      renderCatalogList();
      setTimeout(function() { document.getElementById('catalog-search').focus(); }, 350);
    }

    function closeCatalog() {
      document.getElementById('catalog-overlay').classList.remove('open');
    }

    function getAddedNames() {
      return subjects.map(function(s) { return s.name.trim().toUpperCase(); }).filter(Boolean);
    }

    function buildCatalogTabs() {
      var tabs = document.getElementById('catalog-tabs');
      var terms = ['All'].concat(Object.keys(CATALOG));
      tabs.innerHTML = '';
      terms.forEach(function(term) {
        var btn = document.createElement('button');
        btn.className = 'tab-btn' + (term === catalogActiveTerm ? ' active' : '');
        btn.textContent = term;
        btn.addEventListener('click', function() {
          catalogActiveTerm = term;
          buildCatalogTabs();
          renderCatalogList();
        });
        tabs.appendChild(btn);
      });
    }

    function renderCatalogList() {
      var list    = document.getElementById('catalog-list');
      var query   = catalogQuery.trim().toUpperCase();
      var added   = getAddedNames();
      var terms   = catalogActiveTerm === 'All' ? Object.keys(CATALOG) : [catalogActiveTerm];
      var hasAny  = false;
      list.innerHTML = '';

      function appendCourseItem(c, container) {
        var isAdded = added.includes(c.code + ' — ' + c.title.toUpperCase()) ||
                      added.includes(c.title.toUpperCase()) ||
                      added.includes(c.code.toUpperCase());
        var item = document.createElement('div');
        item.className = 'catalog-item' + (isAdded ? ' added' : '');
        item.innerHTML =
          '<span class="catalog-code">' + c.code + '</span>' +
          '<span class="catalog-title">' + c.title + '</span>' +
          '<span class="catalog-add-icon">' + (isAdded ? '&minus;' : '+') + '</span>';
        item.addEventListener('click', function() {
          var name = c.code + ' — ' + c.title;
          if (item.classList.contains('added')) {
            subjects = subjects.filter(function(s) {
              return s.name.trim().toUpperCase() !== name.toUpperCase();
            });
            if (subjects.length === 0) addBlankSubject();
            renderAll();
            item.classList.remove('added');
            item.querySelector('.catalog-add-icon').innerHTML = '+';
            showToast(c.code + ' removed');
            return;
          }
          var blank = subjects.find(function(s) { return !s.name.trim() && !s.total && !s.attended; });
          if (blank) { blank.name = name; }
          else { subjects.push({ id: Date.now(), name: name, total: '', attended: '' }); }
          renderAll();
          item.classList.add('added');
          item.querySelector('.catalog-add-icon').innerHTML = '&minus;';
          showToast(c.code + ' added');
        });
        container.appendChild(item);
      }

      terms.forEach(function(term) {
        var termData = CATALOG[term];
        var isSubgrouped = !Array.isArray(termData) && termData.subgroups;

        // Check if anything matches the query
        var allCourses = isSubgrouped
          ? termData.subgroups.reduce(function(a, sg) { return a.concat(sg.courses); }, [])
          : termData;
        var anyMatch = allCourses.some(function(c) {
          if (!query) return true;
          return c.code.toUpperCase().includes(query) || c.title.toUpperCase().includes(query);
        });
        if (!anyMatch) return;
        hasAny = true;

        var groupEl = document.createElement('div');
        groupEl.className = 'catalog-term-group';
        if (catalogActiveTerm === 'All') {
          var lbl = document.createElement('div');
          lbl.className = 'catalog-term-label';
          lbl.textContent = term;
          groupEl.appendChild(lbl);
        }

        if (isSubgrouped) {
          termData.subgroups.forEach(function(sg) {
            var sgCourses = sg.courses.filter(function(c) {
              if (!query) return true;
              return c.code.toUpperCase().includes(query) || c.title.toUpperCase().includes(query);
            });
            if (!sgCourses.length) return;
            var sgEl = document.createElement('div');
            sgEl.className = 'catalog-subgroup';
            var sgLbl = document.createElement('div');
            sgLbl.className = 'catalog-subgroup-label';
            sgLbl.textContent = sg.label;
            sgEl.appendChild(sgLbl);
            sgCourses.forEach(function(c) { appendCourseItem(c, sgEl); });
            groupEl.appendChild(sgEl);
          });
        } else {
          var courses = termData.filter(function(c) {
            if (!query) return true;
            return c.code.toUpperCase().includes(query) || c.title.toUpperCase().includes(query);
          });
          courses.forEach(function(c) { appendCourseItem(c, groupEl); });
        }

        // Open minor manual-entry section for Terms 5 & 6
        if (term === 'Term 5' || term === 'Term 6') {
          var minorWrap = document.createElement('div');
          minorWrap.className = 'catalog-open-minor';
          minorWrap.innerHTML =
            '<div class="catalog-open-minor-note">' +
              '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="13" height="13"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>' +
              ' Open Minor &nbsp;<span>— add your open elective manually</span>' +
            '</div>' +
            '<div class="catalog-open-minor-row">' +
              '<input class="catalog-minor-input" type="text" placeholder="e.g. MGT101 \u2014 Management Basics">' +
              '<button class="catalog-minor-btn">+ Add</button>' +
            '</div>';

          var minorInput = minorWrap.querySelector('.catalog-minor-input');
          var minorBtn   = minorWrap.querySelector('.catalog-minor-btn');

          function addOpenMinor() {
            var val = minorInput.value.trim();
            if (!val) { showToast('Enter a subject name'); return; }
            var blank = subjects.find(function(s) { return !s.name.trim() && !s.total && !s.attended; });
            if (blank) { blank.name = val; }
            else { subjects.push({ id: Date.now(), name: val, total: '', attended: '' }); }
            renderAll();
            minorInput.value = '';
            showToast('Open minor added');
          }

          minorBtn.addEventListener('click', addOpenMinor);
          minorInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') addOpenMinor();
          });

          groupEl.appendChild(minorWrap);
        }

        list.appendChild(groupEl);
      });

      if (!hasAny) {
        list.innerHTML = '<div class="catalog-empty">No courses match your search.</div>';
      }
    }

    document.getElementById('catalog-btn').addEventListener('click', openCatalog);
    document.getElementById('catalog-close').addEventListener('click', closeCatalog);

    document.getElementById('catalog-overlay').addEventListener('click', function(e) {
      if (e.target === this) closeCatalog();
    });

    document.getElementById('catalog-search').addEventListener('input', function() {
      catalogQuery = this.value;
      renderCatalogList();
    });

    /* ── Theme toggle ─────────────────────────────────── */
    var SUN_SVG  = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>';
    var MOON_SVG = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16"><path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"/></svg>';

    function applyTheme(t, notify) {
      document.documentElement.setAttribute('data-theme', t);
      localStorage.setItem('theme', t);
      var metaTheme = document.querySelector('meta[name="theme-color"]');
      if (metaTheme) metaTheme.setAttribute('content', t === 'dark' ? '#020617' : '#f8fafc');
      document.getElementById('menu-theme-icon').innerHTML   = t === 'dark' ? MOON_SVG : SUN_SVG;
      document.getElementById('menu-theme-label').textContent = t === 'dark' ? 'Dark Mode' : 'Light Mode';
      if (notify) showToast(t === 'light' ? '☀️ Switched to Light Mode' : '🌙 Switched to Dark Mode');
    }
    applyTheme(localStorage.getItem('theme') || 'dark', false);
    document.getElementById('theme-row').addEventListener('click', function() {
      var current = document.documentElement.getAttribute('data-theme');
      applyTheme(current === 'dark' ? 'light' : 'dark', true);
    });

    /* ── Page size control ───────────────────────────── */
    var ZOOM_MIN = 0.7, ZOOM_MAX = 1.4, ZOOM_STEP = 0.05;
    var currentZoom = parseFloat(localStorage.getItem('pageZoom')) || 1;

    function applyZoom(z, notify) {
      currentZoom = Math.min(ZOOM_MAX, Math.max(ZOOM_MIN, parseFloat(z.toFixed(2))));
      document.documentElement.style.zoom = currentZoom;
      localStorage.setItem('pageZoom', currentZoom);
      var pct = Math.round(currentZoom * 100);
      document.getElementById('size-val').textContent = pct + '%';
      document.getElementById('size-down').disabled = currentZoom <= ZOOM_MIN;
      document.getElementById('size-up').disabled   = currentZoom >= ZOOM_MAX;
      if (notify) showToast('Page size: ' + pct + '%');
    }
    applyZoom(currentZoom, false);
    document.getElementById('size-down').addEventListener('click', function(e) { e.stopPropagation(); applyZoom(currentZoom - ZOOM_STEP, true); });
    document.getElementById('size-up').addEventListener('click',   function(e) { e.stopPropagation(); applyZoom(currentZoom + ZOOM_STEP, true); });

    /* ── 3-dot menu open/close ───────────────────────── */
    var menuBtn      = document.getElementById('menu-btn');
    var menuDropdown = document.getElementById('menu-dropdown');

    menuBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      var isOpen = menuDropdown.classList.contains('open');
      menuDropdown.classList.toggle('open', !isOpen);
      menuBtn.classList.toggle('active', !isOpen);
    });

    // Close when clicking outside
    document.addEventListener('click', function(e) {
      if (!menuDropdown.contains(e.target) && e.target !== menuBtn) {
        menuDropdown.classList.remove('open');
        menuBtn.classList.remove('active');
      }
    });

    // Stop size-row clicks from closing the dropdown
    document.getElementById('theme-row').addEventListener('click', function(e) {
      e.stopPropagation();
    });

    // Dismiss loader after 3.5 seconds
    setTimeout(function() {
      var loader = document.getElementById('loader');
      if (loader) {
        loader.classList.add('loader-hide');
        setTimeout(function() { loader.remove(); }, 600);
      }
    }, 3500);
  </script>
</body>
</html>
